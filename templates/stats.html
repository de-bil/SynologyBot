{% extends "base.html" %}

{% block content %}
<div class="content">
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>üì® –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
            <div class="stat-number total-requests">{{ stats.total_requests }}</div>
            <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</p>
        </div>
        <div class="stat-card">
            <h3>üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            <div class="stat-number unique-users">{{ stats.unique_users }}</div>
            <p>–†–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </div>
        <div class="stat-card">
            <h3>‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</h3>
            <div class="stat-number uptime-display">{{ uptime }}</div>
            <p>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞</p>
        </div>
    </div>

	 <div class="content">
		<h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º <button class="btn" onclick="updateCategoryStats()" style="padding: 5px 10px; font-size: 12px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button></h3>
		<div id="category-stats">
			<table>
				<thead>
					<tr>
						<th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
						<th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤</th>
					</tr>
				</thead>
				<tbody id="category-stats-body">
					{% for category, count in stats.category_stats %}
					<tr>
						<td>{{ category }}</td>
						<td>{{ count }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

	 <div class="content">
		<h3>üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã <button class="btn" onclick="updateRecentRequests()" style="padding: 5px 10px; font-size: 12px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button></h3>
		<div id="recent-requests">
			<table>
				<thead>
					<tr>
						<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
						<th>–í–æ–ø—Ä–æ—Å</th>
						<th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
						<th>–í—Ä–µ–º—è</th>
					</tr>
				</thead>
				<tbody id="recent-requests-body">
					{% for request in stats.recent_requests %}
					<tr>
						<td>{{ request[0] }}</td>
						<td>{{ request[1][:50] }}{% if request[1]|length > 50 %}...{% endif %}</td>
						<td>{{ request[2] if request[2] else 'N/A' }}</td>
						<td>{{ request[3] }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
</div>
</div>

<script>
    function updateAllStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                document.querySelectorAll('.total-requests').forEach(el => {
                    el.textContent = data.total_requests;
                });
                document.querySelectorAll('.unique-users').forEach(el => {
                    el.textContent = data.unique_users;
                });
                document.querySelectorAll('.uptime-display').forEach(el => {
                    el.textContent = data.uptime;
                });
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error));
    }

    setInterval(updateAllStats, 15000);
	
    function updateRecentRequests() {
        const refreshBtn = document.querySelector('button[onclick="updateRecentRequests()"]');
        const originalText = refreshBtn.innerHTML;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        refreshBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
        refreshBtn.disabled = true;
        
        fetch('/api/recent-requests')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('recent-requests-body');
                tbody.innerHTML = '';
                
                data.recent_requests.forEach(request => {
                    const row = document.createElement('tr');
                    
                    const userCell = document.createElement('td');
                    userCell.textContent = request.username;
                    row.appendChild(userCell);
                    
                    const questionCell = document.createElement('td');
                    questionCell.textContent = request.question.length > 50 ? 
                        request.question.substring(0, 50) + '...' : request.question;
                    row.appendChild(questionCell);
                    
                    const categoryCell = document.createElement('td');
                    categoryCell.textContent = request.category;
                    row.appendChild(categoryCell);
                    
                    const timeCell = document.createElement('td');
                    timeCell.textContent = request.timestamp;
                    row.appendChild(timeCell);
                    
                    tbody.appendChild(row);
                });
                
                showNotification('‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
            })
            .finally(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            });
    }
    
    function showNotification(message, type) {
        const existingNotification = document.getElementById('update-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.id = 'update-notification';
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.padding = '10px 15px';
        notification.style.borderRadius = '5px';
        notification.style.color = 'white';
        notification.style.zIndex = '1000';
        notification.style.fontWeight = 'bold';
        notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        
        if (type === 'success') {
            notification.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
        } else {
            notification.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    let autoUpdateInterval = setInterval(updateRecentRequests, 30000);
    
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            clearInterval(autoUpdateInterval);
        } else {
            autoUpdateInterval = setInterval(updateRecentRequests, 30000);
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(updateRecentRequests, 2000);
    });
	function updateCategoryStats() {
		const refreshBtn = document.querySelector('button[onclick="updateCategoryStats()"]');
		const originalText = refreshBtn.innerHTML;
		
		refreshBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
		refreshBtn.disabled = true;
		
		fetch('/api/category-stats')
			.then(response => {
				if (!response.ok) {
					throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
				}
				return response.json();
			})
			.then(data => {
				const tbody = document.getElementById('category-stats-body');
				tbody.innerHTML = '';
				
				if (data.category_stats && data.category_stats.length > 0) {
					data.category_stats.forEach(item => {
						const row = document.createElement('tr');
						
						const categoryCell = document.createElement('td');
						categoryCell.textContent = item.category || 'N/A';
						row.appendChild(categoryCell);
						
						const countCell = document.createElement('td');
						countCell.textContent = item.count || 0;
						row.appendChild(countCell);
						
						tbody.appendChild(row);
					});
					
					showNotification('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
				} else {
					showNotification('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
				}
			})
			.catch(error => {
				console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:', error);
				showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
			})
			.finally(() => {
				refreshBtn.innerHTML = originalText;
				refreshBtn.disabled = false;
			});
	}

	let categoryAutoUpdateInterval = setInterval(updateCategoryStats, 30000);

	document.addEventListener('visibilitychange', function() {
		if (document.hidden) {
			clearInterval(categoryAutoUpdateInterval);
		} else {
			categoryAutoUpdateInterval = setInterval(updateCategoryStats, 30000);
		}
	});

	document.addEventListener('DOMContentLoaded', function() {
		setTimeout(updateCategoryStats, 2000);
	});
</script>
<style>
    #recent-requests table {
        transition: opacity 0.3s ease;
    }
    
    #recent-requests.updating table {
        opacity: 0.7;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #recent-requests-body tr {
        animation: fadeIn 0.5s ease;
    }
	
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .btn.updating {
        animation: spin 1s infinite linear;
    }
</style>

{% endblock %}
